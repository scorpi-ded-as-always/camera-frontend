<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MeowCV Live</title>

  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
    }

    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }

    #cat {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 160px;
      z-index: 10;
    }
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<img id="cat" src="assets/larry.jpeg" />

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script type="module">
/* =========================
   IMPORT MEOWCV LOGIC
========================= */
import { getCatReaction } from "./meowcv.js";

/* =========================
   CONFIG
========================= */
const SERVER_URL = "https://camera-signaling-server.onrender.com";
const video = document.getElementById("video");
const catImg = document.getElementById("cat");

/* =========================
   SOCKET
========================= */
const socket = io(SERVER_URL);

/* =========================
   CAMERA (SINGLE SOURCE)
========================= */
const stream = await navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
});
video.srcObject = stream;

/* =========================
   WEBRTC (SEND STREAM)
========================= */
const pc = new RTCPeerConnection({
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" }
  ]
});

stream.getTracks().forEach(track => pc.addTrack(track, stream));

pc.onicecandidate = event => {
  if (event.candidate) socket.emit("ice", event.candidate);
};

socket.on("answer", answer => {
  pc.setRemoteDescription(answer);
});

socket.on("ice", candidate => {
  pc.addIceCandidate(candidate);
});

socket.on("viewer-ready", async () => {
  console.log("ðŸ‘€ Viewer ready â€” creating offer");

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("offer", offer);
});


/* =========================
   MEDIAPIPE (SAFE MODE)
========================= */
const faceMesh = new FaceMesh({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
  if (!results.multiFaceLandmarks) return;

  const landmarks = results.multiFaceLandmarks[0];
  const cat = getCatReaction(landmarks);
  catImg.src = `assets/${cat}`;
});

/* =========================
   THROTTLED FRAME LOOP
   (MOBILE SAFE)
========================= */
setInterval(async () => {
  if (video.readyState >= 2) {
    await faceMesh.send({ image: video });
  }
}, 100); // 10 FPS

</script>

</body>
</html>

