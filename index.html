<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeowCV Live</title>
  <style>
    body { margin: 0; background: black; overflow: hidden; }
    video { width: 100vw; height: 100vh; object-fit: cover; }
    #cat {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 160px;
    }
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<img id="cat" src="assets/larry.jpeg" />

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
import { getCatReaction } from "./meowcv.js";

const SERVER_URL = "https://camera-signaling-server.onrender.com";

const video = document.getElementById("video");
const catImg = document.getElementById("cat");
const socket = io(SERVER_URL);

// 1️⃣ Get camera stream ONCE
const stream = await navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
});
video.srcObject = stream;

// 2️⃣ Setup WebRTC (SEND STREAM)
const pc = new RTCPeerConnection();
stream.getTracks().forEach(track => pc.addTrack(track, stream));

pc.onicecandidate = e => {
  if (e.candidate) socket.emit("ice", e.candidate);
};

socket.on("answer", answer => {
  pc.setRemoteDescription(answer);
});

socket.on("ice", candidate => {
  pc.addIceCandidate(candidate);
});

const offer = await pc.createOffer();
await pc.setLocalDescription(offer);
socket.emit("offer", offer);

// 3️⃣ Setup MediaPipe (READ SAME STREAM)
const faceMesh = new FaceMesh({
  locateFile: f =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

faceMesh.onResults(results => {
  if (!results.multiFaceLandmarks) return;
  const cat = getCatReaction(results.multiFaceLandmarks[0]);
  catImg.src = `assets/${cat}`;
});

const camera = new Camera(video, {
  onFrame: async () => {
    await faceMesh.send({ image: video });
  },
  width: 640,
  height: 480
});
camera.start();
</script>

</body>
</html>
